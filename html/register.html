<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/register.css">
    <link rel="shortcut icon" href="../img/logoNoBackground.png" type="image/x-icon">
    <script src="../js/fallbackButton.js" defer></script>
    <title>Glowered Store - Cadastro</title>
</head>

<body>
    <header>
        <a id="backBtn" class="back" href="../index.html" aria-label="Voltar">← Voltar</a>
        <img src="https://i.ibb.co/Cp7X7djf/entrarnaglowered.png" alt="pagina de login">
    </header>
    <main>
        <form id="registerForm">
            <!-- Mensagens de feedback -->
            <div id="error-message" style="display: none; color: #ff2d95; text-align: center; margin-bottom: 1rem; font-family: 'Share Tech Mono', monospace;"></div>
            <div id="success-message" style="display: none; color: #00e6a8; text-align: center; margin-bottom: 1rem; font-family: 'Share Tech Mono', monospace;"></div>

            <label for="userName">Digite seu nome</label>
            <input type="text" placeholder="Nome completo" id="userName" required>
            
            <label for="cpf">Digite seu CPF</label>
            <input type="text" placeholder="000.000.000-00" id="cpf" required>
            
            <label for="email">Digite seu email</label>
            <input type="email" placeholder="seu@email.com" id="email" required>
            
            <label for="telefone">Digite seu número</label>
            <input type="tel" placeholder="(00) 00000-0000" id="telefone">
            
            <label for="password">Digite sua senha</label>
            <input type="password" placeholder="Sua senha" id="password" required>
            
            <button type="submit" id="btnRegister">Cadastrar</button>
            
            <p id="refRegister">Caso <b>Já Possua</b> uma conta clique <a href="./login.html" id="refRegisterLink">Aqui</a></p>
        </form>
    </main>
    <footer>
        <p>&copy; Glowered Store</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const registerForm = document.getElementById('registerForm');
            const errorMessage = document.getElementById('error-message');
            const successMessage = document.getElementById('success-message');
            const btnRegister = document.getElementById('btnRegister');

            registerForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Coletar dados do formulário
                const userData = {
                    nome: document.getElementById('userName').value,
                    cpf: document.getElementById('cpf').value,
                    email: document.getElementById('email').value,
                    telefone: document.getElementById('telefone').value,
                    senha: document.getElementById('password').value,
                    tipo: 'cliente' // Definido como padrão para cadastro
                };

                // Validações básicas
                if (!userData.nome || !userData.cpf || !userData.email || !userData.senha) {
                    showError('Por favor, preencha todos os campos obrigatórios.');
                    return;
                }

                if (!isValidEmail(userData.email)) {
                    showError('Por favor, insira um email válido.');
                    return;
                }

                if (userData.senha.length < 6) {
                    showError('A senha deve ter pelo menos 6 caracteres.');
                    return;
                }

                try {
                    // Mostrar loading
                    btnRegister.textContent = 'CADASTRANDO...';
                    btnRegister.disabled = true;
                    errorMessage.style.display = 'none';

                    // Carregar auth.js apenas quando necessário
                    await loadAuthJS();
                    
                    // Fazer cadastro
                    const resultado = await cadastrar(userData);
                    
                    // Cadastro bem-sucedido
                    successMessage.textContent = 'Cadastro realizado com sucesso! Redirecionando para login...';
                    successMessage.style.display = 'block';
                    
                    // Redirecionar para login com mensagem de sucesso
                    setTimeout(() => {
                        window.location.href = 'login.html?cadastro=sucesso';
                    }, 2000);

                } catch (error) {
                    showError(error.message || 'Erro ao realizar cadastro. Tente novamente.');
                    
                    // Restaurar botão
                    btnRegister.textContent = 'Cadastrar';
                    btnRegister.disabled = false;
                }
            });

            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                successMessage.style.display = 'none';
            }

            function isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            // Carregar auth.js apenas quando necessário
            function loadAuthJS() {
                return new Promise((resolve, reject) => {
                    if (typeof window.cadastrar === 'function') {
                        resolve();
                        return;
                    }

                    const script = document.createElement('script');
                    script.src = '../js/auth.js';
                    script.onload = resolve;
                    script.onerror = () => reject(new Error('Erro ao carregar sistema de cadastro'));
                    document.head.appendChild(script);
                });
            }

            // Limpar mensagens ao digitar
            const inputs = ['userName', 'cpf', 'email', 'telefone', 'password'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    errorMessage.style.display = 'none';
                    successMessage.style.display = 'none';
                });
            });

            // Máscara para CPF
            document.getElementById('cpf').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    value = value.replace(/(\d{3})(\d)/, '$1.$2')
                                .replace(/(\d{3})(\d)/, '$1.$2')
                                .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                }
                e.target.value = value;
            });

            // Máscara para telefone
            document.getElementById('telefone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    value = value.replace(/(\d{2})(\d)/, '($1) $2')
                                .replace(/(\d{5})(\d)/, '$1-$2');
                }
                e.target.value = value;
            });
        });
    </script>
</body>
</html>